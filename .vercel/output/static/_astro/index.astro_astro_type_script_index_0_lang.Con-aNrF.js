const x=document.getElementById("usernameInput"),f=document.getElementById("searchBtn"),A=document.getElementById("languageSelect"),U=document.querySelectorAll(".user-tag"),L=document.querySelectorAll(".faq-item"),B=document.getElementById("profileDisplay"),_={en:{title:"Anonymous Instagram browsing",subtitle:"Enter needed username in the search bar using formats username, @username or https://www.instagram.com/username/",placeholder:"Enter Instagram username...",submit:"Submit",popularSearches:"Popular searches:",features:"Insta-Stories-Viewer Features",featuresIntro:"InstaStoriesViewer is a free service for anonymous viewing of Instagram stories from open accounts that does not require user authorization in the Instagram social network. The functionality presented on the platform is completely free, allows you to watch stories anonymously and does not require any additional actions, except for the introduction of the user's nickname Instagram.",anonymity:"100% anonymity",anonymityDesc:"The account owner does not see your data in their views statistics",noAccount:"No account needed",noAccountDesc:"There is no need to create an Instagram account. You also have the opportunity to watch user stories and other multimedia publications without registration and application",loading:"Loading capability",loadingDesc:"You can view, download and download stories, publications and other information for free on any device: computer, laptop, tablet or smartphone (Android, iOS and other operating systems)",howItWorks:"How is hidden viewing of Instagram Stories?",step1:"You enter the name of a user that interests you",step2:"The entered nickname gets into the system and is processed by our bot",step3:"The service opens the user's page, where the latest relevant data is displayed",step4:"Instagram user stories store the name of one of our accounts",step5:"You remain anonymous",startSearching:"To start searching",faq:"Frequently asked questions"},it:{title:"Navigazione Instagram anonima",subtitle:"Inserisci il nome utente necessario nella barra di ricerca utilizzando i formati username, @username o https://www.instagram.com/username/",placeholder:"Inserisci nome utente Instagram...",submit:"Invia",popularSearches:"Ricerche popolari:",features:"Caratteristiche Insta-Stories-Viewer",featuresIntro:"InstaStoriesViewer è un servizio gratuito per la visualizzazione anonima delle storie Instagram da account aperti che non richiede autorizzazione utente nel social network Instagram.",anonymity:"100% anonimato",anonymityDesc:"Il proprietario dell'account non vede i tuoi dati nelle loro statistiche di visualizzazione",noAccount:"Nessun account necessario",noAccountDesc:"Non è necessario creare un account Instagram. Hai anche l'opportunità di guardare le storie degli utenti e altre pubblicazioni multimediali senza registrazione e applicazione",loading:"Capacità di caricamento",loadingDesc:"Puoi visualizzare, scaricare e scaricare storie, pubblicazioni e altre informazioni gratuitamente su qualsiasi dispositivo: computer, laptop, tablet o smartphone (Android, iOS e altri sistemi operativi)",howItWorks:"Come funziona la visualizzazione nascosta delle Storie Instagram?",step1:"Inserisci il nome di un utente che ti interessa",step2:"Il nickname inserito entra nel sistema e viene elaborato dal nostro bot",step3:"Il servizio apre la pagina dell'utente, dove vengono visualizzati i dati rilevanti più recenti",step4:"Le storie degli utenti Instagram memorizzano il nome di uno dei nostri account",step5:"Rimani anonimo",startSearching:"Per iniziare la ricerca",faq:"Domande frequenti"}};document.addEventListener("DOMContentLoaded",function(){D(),P(),N()});function D(){f.addEventListener("click",C),x.addEventListener("keypress",function(e){e.key==="Enter"&&C()}),U.forEach(e=>{e.addEventListener("click",function(){const n=this.textContent.replace("@","");x.value=n,C()})});const t=document.querySelector(".btn-primary");t&&t.addEventListener("click",function(){x.scrollIntoView({behavior:"smooth"}),x.focus()})}function C(){const t=x.value.trim();if(!t){b("Please enter a username","error");return}const e=t.replace(/^@/,"").replace(/^https?:\/\/(www\.)?instagram\.com\//,"").replace(/\/$/,"").trim();if(!e){b("Please enter a valid username","error");return}f.disabled=!0,f.innerHTML="Loading...",fetch(`/api/full/${e}`).then(n=>n.json()).then(n=>{f.innerHTML="Submit",f.disabled=!1,n.success?(b(`Found profile: @${e}`,"success"),j(n.data)):b(n.error||"Profile not found","error")}).catch(n=>{f.innerHTML="Submit",f.disabled=!1,console.error("Error:",n),b("Error connecting to server. Make sure the backend is running on port 3001","error")})}function P(){L.forEach(t=>{t.querySelector(".faq-question").addEventListener("click",function(){V(t)})})}function V(t){const e=t.classList.contains("active");L.forEach(n=>{n.classList.remove("active")}),e||t.classList.add("active")}function N(){A.addEventListener("change",function(){const t=this.value;H(t)})}function H(t){const e=_[t];if(!e)return;document.querySelector(".hero-title").textContent=e.title,document.querySelector(".hero-subtitle").textContent=e.subtitle,document.querySelector(".search-input").placeholder=e.placeholder,document.querySelector(".search-btn").textContent=e.submit,document.querySelector(".popular-users p").textContent=e.popularSearches,document.querySelector(".features h3").textContent=e.features,document.querySelector(".features-intro").textContent=e.featuresIntro,document.querySelector(".how-it-works h3").textContent=e.howItWorks,document.querySelector(".btn-primary").textContent=e.startSearching,document.querySelector(".faq h3").textContent=e.faq;const n=document.querySelectorAll(".feature-card");n.length>=3&&(n[0].querySelector("h4").textContent=e.anonymity,n[0].querySelector("p").textContent=e.anonymityDesc,n[1].querySelector("h4").textContent=e.noAccount,n[1].querySelector("p").textContent=e.noAccountDesc,n[2].querySelector("h4").textContent=e.loading,n[2].querySelector("p").textContent=e.loadingDesc);const o=document.querySelectorAll(".step");o.length>=5&&(o[0].querySelector("p").textContent=e.step1,o[1].querySelector("p").textContent=e.step2,o[2].querySelector("p").textContent=e.step3,o[3].querySelector("p").textContent=e.step4,o[4].querySelector("p").textContent=e.step5)}function j(t){const e=t.profile?.result||{},n=t.posts?.result||{},o=t.stories?.result||{},s=t.highlights?.result||{},r=e.username||t.username,l=e.full_name||r,c=e.biography||"No bio available",i=e.profile_pic_url||"",a=e.edge_owner_to_timeline_media?.count||0,u=e.edge_followed_by?.count||0,m=e.edge_follow?.count||0;document.getElementById("profileUsername").textContent=`@${r}`,document.getElementById("profileName").textContent=l,document.getElementById("profileBio").textContent=c,document.getElementById("postsCount").textContent=`${a} posts`,document.getElementById("followersCount").textContent=`${h(u)} followers`,document.getElementById("followingCount").textContent=`${h(m)} following`;const d=document.getElementById("profileImage");i&&(d.src=i,d.alt=l,d.crossOrigin="anonymous",d.onerror=function(){const v=`/api/image-proxy?url=${encodeURIComponent(i)}`;fetch(v).then(g=>{const E=g.headers.get("content-type");if(E&&E.includes("application/json")){this.style.display="none";const I=document.createElement("div");I.style.cssText="width:100px; height:100px; background:#f3f4f6; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px; text-align:center;",I.textContent="Profile image blocked by Instagram",this.parentNode.insertBefore(I,this)}else this.src=v}).catch(()=>{this.src=v,this.onerror=function(){this.style.display="none";const g=document.createElement("div");g.style.cssText="width:100px; height:100px; background:#f3f4f6; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px; text-align:center;",g.textContent="Profile image blocked by Instagram",this.parentNode.insertBefore(g,this)}})}),B.style.display="block",B.scrollIntoView({behavior:"smooth"}),window.currentProfileData={username:r,fullName:l,bio:c,profileImage:i,followers:u,following:m,postsCount:a,posts:n.edges||[],stories:o.edges||o||[],highlights:s.tray||s.edges||(Array.isArray(s)?s:[])},console.log("Loading posts:",window.currentProfileData.posts),z(window.currentProfileData.posts)}document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",function(){document.querySelectorAll(".tab-btn").forEach(o=>o.classList.remove("active")),this.classList.add("active");const e=window.currentProfileData;if(!e)return;const n=this.getAttribute("data-tab");O(n,e)})});function O(t,e){switch(document.getElementById("contentGrid"),t){case"stories":R(e.stories||[]);break;case"posts":z(e.posts||[]);break;case"highlights":G(e.highlights||[]);break}}function R(t){const e=document.getElementById("contentGrid");if(console.log("Loading stories:",t),!t||t.length===0){e.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #666;">No stories available. Stories are only accessible through InstaStoriesViewer service.</div>';return}const n=t.map((o,s)=>{const r=o.node||o,l=r.is_video||r.media_type===2,c=r.image_versions2?.candidates||[],i=c.length>0?c[0].url:"";return`${r.owner?.username||"unknown"}${r.id}`,`
                <div class="content-item story-item" data-story-index="${s}">
                    <img src="${i}" alt="Story" loading="lazy" 
                         onerror="
                            const proxyUrl = '/api/image-proxy?url=' + encodeURIComponent('${i}');
                            fetch(proxyUrl)
                                .then(response => {
                                    const contentType = response.headers.get('content-type');
                                    if (contentType && contentType.includes('application/json')) {
                                        this.style.display='none'; 
                                        this.nextElementSibling.style.display='flex';
                                    } else {
                                        this.src = proxyUrl;
                                    }
                                })
                                .catch(() => {
                                    this.src = proxyUrl;
                                    this.onerror = function() {
                                        this.style.display='none'; 
                                        this.nextElementSibling.style.display='flex';
                                    };
                                });
                         " />
                    <div class="image-fallback" style="display:none; width:100%; height:100%; background:#f3f4f6; align-items:center; justify-content:center; color:#9ca3af; font-size:14px;">
                        <span>Story blocked by Instagram</span>
                    </div>
                    ${l?'<div class="video-indicator"><i class="fas fa-play"></i></div>':""}
                    <div class="story-overlay">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
            `}).join("");e.innerHTML=n,e.querySelectorAll(".story-item").forEach((o,s)=>{o.addEventListener("click",()=>{F(t[s])})})}function z(t){const e=document.getElementById("contentGrid");if(!t||t.length===0){e.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #666;">No posts available.</div>';return}const n=t.map(o=>{const s=o.node||o,r=s.media_type===2||s.is_video,l=s.image_versions2?.candidates||[],c=l.length>0?l[0].url:"",i=s.caption?.text||"Instagram Post",a=s.like_count||0,u=s.comment_count||0;`${s.code}`;const m=r?'<div class="video-indicator"><i class="fas fa-play"></i></div>':"";return new Date(s.taken_at*1e3).toLocaleString("en-GB",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),`
                <div class="content-item post-item" data-post-index="${t.indexOf(o)}">
                    <img src="${c}" alt="${i.substring(0,50)}..." loading="lazy" 
                         crossorigin="anonymous"
                           onerror="
                              const proxyUrl = '/api/image-proxy?url=' + encodeURIComponent('${c}');
                              fetch(proxyUrl)
                                  .then(response => {
                                      const contentType = response.headers.get('content-type');
                                      if (contentType && contentType.includes('application/json')) {
                                          // Image is blocked, show fallback
                                          this.style.display='none'; 
                                          this.nextElementSibling.style.display='flex';
                                      } else {
                                          // Image is available, set src
                                          this.src = proxyUrl;
                                      }
                                  })
                                  .catch(() => {
                                      // If fetch fails, try direct proxy
                                      this.src = proxyUrl;
                                      this.onerror = function() {
                                          this.style.display='none'; 
                                          this.nextElementSibling.style.display='flex';
                                      };
                                  });
                           " />
                    <div class="image-fallback" style="display:none; width:100%; height:100%; background:#f3f4f6; align-items:center; justify-content:center; color:#9ca3af; font-size:14px;">
                        <span>Image blocked by Instagram</span>
                    </div>
                    ${m}
                    <div class="post-stats">
                        <span><i class="fas fa-heart"></i> ${h(a)}</span>
                        <span><i class="fas fa-comment"></i> ${h(u)}</span>
                    </div>
                </div>
            `}).join("");e.innerHTML=n,e.querySelectorAll(".post-item").forEach((o,s)=>{o.addEventListener("click",()=>{J(t[s])})})}function G(t){const e=document.getElementById("contentGrid");if(console.log("Loading highlights:",t),!t||t.length===0){e.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #666;">No highlights available.</div>';return}const n=t.map(o=>{const s=o.node||o,l=(s.cover_media||{}).image_versions2?.candidates||[],c=l.length>0?l[0].url:"",i=s.title||"Highlight",a=`https://www.instagram.com/stories/highlights/${s.id}/`,u=c?`/api/image-proxy?url=${encodeURIComponent(c)}`:"";return`
                <div class="content-item highlight-item" onclick="openHighlight('${a}')">
                    ${c?`<img src="${u}" alt="${i}" loading="lazy"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`:""}
                    <div class="image-fallback" style="${c?"display:none;":"display:flex;"} width:100%; height:100%; background:#f3f4f6; align-items:center; justify-content:center; color:#9ca3af; font-size:14px;">
                        <span>Image blocked by Instagram</span>
                    </div>
                    <div class="highlight-overlay">
                        <span>${i}</span>
                    </div>
                </div>
            `}).join("");e.innerHTML=n}function h(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t.toString()}let y=[],p=0,w,S;function F(t){if(y=window.currentProfileData?.stories||[],p=y.findIndex(e=>JSON.stringify(e)===JSON.stringify(t)),p===-1){console.error("Story not found in current stories");return}q(t)}function q(t){const e=document.getElementById("storyModal"),n=document.getElementById("storyImage"),o=document.getElementById("storyVideo"),s=document.getElementById("storyUserAvatar"),r=document.getElementById("storyUsername"),l=document.getElementById("storyTime");document.getElementById("storyProgress");const c=window.currentProfileData?.username||"unknown";r.textContent=`@${c}`,l.textContent="2h ago",s.src=window.currentProfileData?.profileImage||"";const i=t.node||t,a=i.is_video||i.media_type===2,u=i.image_versions2?.candidates||[],m=i.video_versions||[];if(n.style.display="none",o.style.display="none",a&&m.length>0){const d=m[0].url;o.src=`/api/image-proxy?url=${encodeURIComponent(d)}`,o.style.display="block",o.load(),console.log("Loading video:",d)}else if(u.length>0){const d=u[0].url;n.src=`/api/image-proxy?url=${encodeURIComponent(d)}`,n.style.display="block",console.log("Loading image:",d)}e.style.display="flex",Y(),S=setTimeout(()=>{M()},5e3)}function Y(){const t=document.getElementById("storyProgress");t.style.width="0%";let e=0;w=setInterval(()=>{e+=2,t.style.width=e+"%",e>=100&&clearInterval(w)},100)}function M(){y.length!==0&&(clearInterval(w),clearTimeout(S),p=(p+1)%y.length,q(y[p]))}function W(){y.length!==0&&(clearInterval(w),clearTimeout(S),p=p===0?y.length-1:p-1,q(y[p]))}function $(){const t=document.getElementById("storyModal");t.style.display="none",clearInterval(w),clearTimeout(S);const e=document.getElementById("storyVideo");e.pause(),e.currentTime=0}function J(t){const e=document.getElementById("postModal"),n=document.getElementById("postModalImage"),o=document.getElementById("postModalVideo"),s=document.getElementById("postUserAvatar"),r=document.getElementById("postUsername"),l=document.getElementById("postModalLikes"),c=document.getElementById("postModalComments"),i=document.getElementById("postModalCaption"),a=t.node||t,u=a.media_type===2||a.is_video,m=a.image_versions2?.candidates||[],d=a.video_versions||[],v=a.caption?.text||"",g=a.like_count||0,E=a.comment_count||0;`${a.code}`;const I=window.currentProfileData?.username||"unknown";if(r.textContent=`@${I}`,s.src=window.currentProfileData?.profileImage||"",l.innerHTML=`<i class="fas fa-heart"></i> ${h(g)}`,c.innerHTML=`<i class="fas fa-comment"></i> ${h(E)}`,i.textContent=v,n.style.display="none",o.style.display="none",u&&d.length>0){const k=d[0].url;o.src=`/api/image-proxy?url=${encodeURIComponent(k)}`,o.style.display="block",o.load()}else if(m.length>0){const k=m[0].url;n.src=`/api/image-proxy?url=${encodeURIComponent(k)}`,n.style.display="block"}e.style.display="flex"}function T(){const t=document.getElementById("postModal");t.style.display="none";const e=document.getElementById("postModalVideo");e.pause(),e.currentTime=0}document.getElementById("storyModal").addEventListener("click",function(t){t.target===this&&$()});document.getElementById("postModal").addEventListener("click",function(t){t.target===this&&T()});document.addEventListener("keydown",function(t){const e=document.getElementById("storyModal"),n=document.getElementById("postModal");if(e.style.display==="flex")switch(t.key){case"ArrowLeft":t.preventDefault(),W();break;case"ArrowRight":t.preventDefault(),M();break;case"Escape":t.preventDefault(),$();break}else n.style.display==="flex"&&t.key==="Escape"&&(t.preventDefault(),T())});function b(t,e){document.querySelectorAll(".message").forEach(r=>r.remove());const o=document.createElement("div");o.className=`message ${e}`,o.textContent=t;const s=document.querySelector(".search-container");s.parentNode.insertBefore(o,s.nextSibling),setTimeout(()=>{o.remove()},5e3)}document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(e){e.preventDefault();const n=document.querySelector(this.getAttribute("href"));n&&n.scrollIntoView({behavior:"smooth",block:"start"})})});function Q(){const t={threshold:.1,rootMargin:"0px 0px -50px 0px"},e=new IntersectionObserver(n=>{n.forEach(o=>{o.isIntersecting&&(o.target.style.opacity="1",o.target.style.transform="translateY(0)")})},t);document.querySelectorAll(".feature-card, .step").forEach(n=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="opacity 0.6s ease, transform 0.6s ease",e.observe(n)})}document.addEventListener("DOMContentLoaded",Q);document.addEventListener("keydown",function(t){t.key==="Escape"&&L.forEach(e=>{e.classList.remove("active")})});document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("button, input, select, a").forEach(e=>{e.addEventListener("focus",function(){this.style.outline="2px solid #667eea",this.style.outlineOffset="2px"}),e.addEventListener("blur",function(){this.style.outline="none"})})});
